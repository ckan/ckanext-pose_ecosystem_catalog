<section class="section ecosystem-map-section">
  <div class="module-content">
    <div class="ecosystem-map-container">
      <div id="homepage-map"></div>
    </div>
  </div>
</section>

<link rel="stylesheet" href="{{ h.url_for_static('/ckan_map/css/maplibre-gl.css') }}">

<style>
  .ecosystem-map-section {
    padding: 0;
    margin: 0;
  }

  .ecosystem-map-container {
    position: relative;
    overflow: hidden;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
  }

  #homepage-map {
    width: 100%;
    height: 700px;
  }

  .maplibregl-popup-content {
    padding: 1rem;
    max-width: 280px;
  }

  .maplibregl-popup-content h3 {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #1e1b4b;
  }

  .maplibregl-popup-content a {
    display: block;
    color: #4f46e5;
    text-decoration: underline;
    margin-bottom: 0.25rem;
    font-weight: 500;
  }

  .maplibregl-popup-content .description {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script src="{{ h.url_for_static('/ckan_map/js/maplibre-gl.js') }}"></script>
<script>
(function() {
  const map = new maplibregl.Map({
    container: 'homepage-map',
    style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
    center: [0, 20],
    zoom: 1.2
  });

  map.on('load', () => {
    map.addSource('sites', {
      type: 'geojson',
      data: 'https://raw.githubusercontent.com/dathere/pose-ckanext-metadata/main/map-data/sites.geojson',
      cluster: true,
      clusterMaxZoom: 14,
      clusterRadius: 50
    });

    // Cluster circles with step-based coloring
    map.addLayer({
      id: 'clusters',
      type: 'circle',
      source: 'sites',
      filter: ['has', 'point_count'],
      paint: {
        'circle-color': [
          'step', ['get', 'point_count'],
          '#abc1d7', 10,
          '#eae735', 100,
          '#ed5248'
        ],
        'circle-radius': 20,
        'circle-opacity': 0.6
      }
    });

    // Cluster count labels
    map.addLayer({
      id: 'cluster-count',
      type: 'symbol',
      source: 'sites',
      filter: ['has', 'point_count'],
      layout: {
        'text-field': '{point_count_abbreviated}',
        'text-size': 12
      }
    });

    // Unclustered individual points
    map.addLayer({
      id: 'unclustered-point',
      type: 'circle',
      source: 'sites',
      filter: ['!', ['has', 'point_count']],
      paint: {
        'circle-color': '#ed5248',
        'circle-radius': 4,
        'circle-stroke-width': 1,
        'circle-stroke-color': '#fff',
        'circle-opacity': 0.4
      }
    });

    // Zoom into cluster on click
    map.on('click', 'clusters', async (e) => {
      var features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
      var clusterId = features[0].properties.cluster_id;
      var zoom = await map.getSource('sites').getClusterExpansionZoom(clusterId);
      map.easeTo({ center: features[0].geometry.coordinates, zoom: zoom });
    });

    // Popup on individual point click
    map.on('click', 'unclustered-point', (e) => {
      var coordinates = e.features[0].geometry.coordinates.slice();
      var props = e.features[0].properties;

      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      new maplibregl.Popup()
        .setLngLat(coordinates)
        .setHTML(
          '<article>' +
          '<h3>' + props.title + '</h3>' +
          '<a href="' + props.url + '" target="_blank" rel="noopener">Visit Site</a>' +
          '<a href="' + props.catalog_url + '" target="_blank" rel="noopener">Catalog Listing</a>' +
          '<div class="description">' + (props.description || 'No description available.') + '</div>' +
          '</article>'
        )
        .addTo(map);
    });

    // Cursor handlers
    map.on('mouseenter', 'clusters', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'clusters', () => { map.getCanvas().style.cursor = ''; });
    map.on('mouseenter', 'unclustered-point', () => { map.getCanvas().style.cursor = 'pointer'; });
    map.on('mouseleave', 'unclustered-point', () => { map.getCanvas().style.cursor = ''; });

    map.scrollZoom.disable();
    map.addControl(new maplibregl.NavigationControl({
      visualizePitch: true,
      showZoom: true,
      showCompass: true
    }));
  });
})();
</script>