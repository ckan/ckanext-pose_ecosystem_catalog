<section class="main-browse section ecosystem-map-section">
  <div class="module-content">
    <div class="container map-heading-container">
      <h4 class="heading-explanation above-heading">
        Explore CKAN sites around the world.
      </h4>
      <h2 class="heading">
        <a href="{{ h.url_for('ckan_map.map_view') }}">
          Ecosystem Map
        </a>
      </h2>
    </div>
    <div class="ecosystem-map-container">
      <div id="homepage-map"></div>
    </div>
  </div>
</section>

<link rel="stylesheet" href="{{ h.url_for_static('/ckan_map/css/maplibre-gl.css') }}">

<style>
  .ecosystem-map-section {
    padding: 2rem 0 0 0;
  }

  .map-heading-container {
    padding-bottom: 1.5rem;
  }

  .ecosystem-map-container {
    position: relative;
    overflow: hidden;
    width: 100vw;
    margin-left: calc(-50vw + 50%);
  }

  #homepage-map {
    width: 100%;
    height: 500px;
  }

  .maplibregl-popup-content {
    padding: 1rem;
    max-width: 280px;
  }

  .maplibregl-popup-content h3 {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #1e1b4b;
  }

  .maplibregl-popup-content a {
    display: block;
    color: #4f46e5;
    text-decoration: underline;
    margin-bottom: 0.25rem;
    font-weight: 500;
  }

  .maplibregl-popup-content .description {
    font-size: 0.8rem;
    color: #666;
    margin-top: 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script src="{{ h.url_for_static('/ckan_map/js/maplibre-gl.js') }}"></script>
<script>
(function() {
  const maptilerKey = '{{ h.pose_theme_get_maptiler_api_key() }}';
  const map = new maplibregl.Map({
    container: 'homepage-map',
    style: 'https://api.maptiler.com/maps/dataviz/style.json?key=' + maptilerKey,
    center: [0, 20],
    zoom: 1.2
  });

  map.on('load', () => {
    map.addSource('sites', {
      type: 'geojson',
      data: '{{ h.url_for("ckan_map.site_geojson") }}'
    });

    map.addLayer({
      id: 'sites-points',
      type: 'circle',
      source: 'sites',
      paint: {
        'circle-stroke-color': '#372AAC',
        'circle-color': '#FFDF20',
        'circle-stroke-width': 1.5,
        'circle-radius': 5
      }
    });

    const hoverPopup = new maplibregl.Popup({
      closeButton: false,
      closeOnClick: false
    });

    const clickPopup = new maplibregl.Popup({
      closeButton: true,
      closeOnClick: true
    });

    map.on('mouseenter', 'sites-points', (e) => {
      map.getCanvas().style.cursor = 'pointer';
      const coordinates = e.features[0].geometry.coordinates.slice();
      const title = e.features[0].properties.title;

      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      hoverPopup
        .setLngLat(coordinates)
        .setHTML('<div style="font-weight: bold;">' + title + '</div>')
        .addTo(map);
    });

    map.on('mouseleave', 'sites-points', () => {
      map.getCanvas().style.cursor = '';
      hoverPopup.remove();
    });

    map.scrollZoom.disable();

    map.addControl(new maplibregl.NavigationControl({
      visualizePitch: true,
      showZoom: true,
      showCompass: true
    }));

    map.on('click', 'sites-points', (e) => {
      const coordinates = e.features[0].geometry.coordinates.slice();
      const props = e.features[0].properties;

      while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
      }

      clickPopup
        .setLngLat(coordinates)
        .setHTML(
          '<article>' +
          '<h3>' + props.title + '</h3>' +
          '<a href="' + props.url + '" target="_blank" rel="noopener">Visit Site</a>' +
          '<a href="' + props.catalog_url + '" target="_blank" rel="noopener">Catalog Listing</a>' +
          '<div class="description">' + (props.description || 'No description available.') + '</div>' +
          '</article>'
        )
        .addTo(map);
    });
  });
})();
</script>